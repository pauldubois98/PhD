% https://github.com/pauldubois98/SFPM-JS2024
\section[DVH Guided Deep Dose]{Dose-Volume Histograms Guided Deep Dose Prediction for Radiotherapy Treatment Planning (SFPM 2024)}
\subsection{Introduction}
Traditionally, the creation of radiotherapy treatment plans has been a semi-manual process, where dosimetrists finetune importance factors assigned to structures and constraints.
A cost function is then used through a classical optimization algorithm to calculate the optimal plan.

In recent years, deep learning in treatment planning has gained attention.
Deep learning models can predict the three-dimensional dose distribution based on patient-specific anatomical data derived from medical imaging (CT scans).
While the predicted dose distribution may not directly represent a deliverable treatment plan, it serves as the basis for determining a clinically viable plan through dose mimicking.
Dose mimicking is an optimization technique that eliminates the need for manual adjustment of importance factors by dosimetrists.
Therefore, the ability to predict a clinically acceptable and near-deliverable 3D dose distribution for any patient presents significant potential for fully automating the radiotherapy planning process.
It is important to note that the successful application of dose mimicking requires a target dose distribution that is nearly deliverable; thus, arbitrarily setting the target dose to zero for OARs is not feasible.

However, this approach requires further adaptation to accommodate specific clinical guidelines.
A potential solution involves training individualized models for each treatment center, allowing institution-specific practices and guidelines to be incorporated.
However, deep learning dose prediction models are computationally large, and implementing separate models for each center is resource-intensive.
Furthermore, such models require substantial datasets for effective training.
Consequently, smaller treatment centers may lack the necessary data volume to train a comprehensive model adequately.
Additionally, a separate model may be required for each prescription type due to the variability in prescription doses, making manual treatment planning necessary for non-standard cases.
Finally, clinicians and dosimetrists may prefer manually adjusting treatment plans in some cases.
Such adjustments are not feasible within the current model framework.

We propose a novel approach that incorporates target DVHs directly into the input of the deep learning-based dose prediction model.
Incorporating DVHs introduces interactivity into the model, allowing adjustments to the target DVH to yield corresponding changes in dose predictions.
This methodology enables a workflow where dosimetrists can refine the predicted dose distribution according to specific clinical objectives.
Furthermore, by establishing a template target DVH tailored to each clinic, the same model can be deployed across multiple centers while generating 3D dose predictions that align with the specific practices of each institution.

\subsection{Material and Methods}
\paragraph{Data size}
We defined a bounding box of dimensions $120 \times 180 \times 180\ \text{mm}^3$ centered on the PTV, with isotropic voxels of $5 \times 5 \times 5\ \text{mm}^3$.
This box size was chosen to accommodate the PTV and the relevant OARs, namely the rectum and bladder, while maintaining a balance between computational feasibility and model accuracy.
A larger bounding box would have increased model complexity and computational time without substantial benefit.

\paragraph{Dataset and Patient Cohort}
The dataset used for model training comprised 168 patients from the Institut régional du Cancer de Montpellier radiotherapy department.
These patients were selected based on their anatomical conformity to the $120 \times 180 \times 180\ \text{mm}^3$ bounding box.
These patients received either $62\,\text{Gy}$ or $78\,\textit{Gy}$ prescribed doses to the PTV, with OARs including the bladder and rectum.
The dataset was split into training, validation, and test subsets, with 80\% used for training, 10\% for validation, and 10\% for testing.

\paragraph{Base Architecture}
The model architecture is based on a 3D U-net, a well-established neural network architecture for volumetric data.
The input to the network consisted of four elements: the patient's CT scan, the contour of the PTV, the rectum contour, and the bladder contour.
The model output was the predicted three-dimensional dose distribution.
The encoder part of the U-net consisted of four convolutional layers with residual connections to improve gradient flow during training, while the decoder section included five convolutional layers.
Skip connections were implemented between the corresponding encoder and decoder layers to preserve spatial information across the model.

\paragraph{Incorporation of Dose-Volume Histograms}
Dose-volume histograms represent one-dimensional curves, whereas the CT images, anatomical contours, and predicted dose distributions are inherently three-dimensional data.
We employed the Direct Affine Feature Transforms (DAFT) technique to integrate these disparate data types within the neural network.
%add citation [3]
DAFT dynamically scales latent feature maps within the network, enabling the combination of imaging data with DVH information.

For this study, we incorporated the DVHs for the primary structures of interest: the PTV, rectum, and bladder.
Not all points along a DVH curve hold equal clinical significance. Dosimetrists typically focus on regions at the beginning and end of the curve, where the volume approaches 0\% or 100\%.
To better capture these critical areas, we employed a non-uniform sampling strategy based on the Chebyshev distribution, which provides a higher density of points near the curve's extremities.
The Chebyshev points, defined in the range $\left[ -1, 1 \right]$, were remapped to the interval $\left[ 0, 1 \right]$ for this purpose.
Given their critical importance in clinical decision-making, this sampling technique allows us to prioritize accurate sampling at the curve's extremities.
The sampled points were subsequently processed by a two-layer perceptron, responsible for predicting the scaling parameters, $\alpha$ and $\beta$, used by the DAFT mechanism to modulate the feature maps.

\paragraph{Three models comparison}
We evaluated three model configurations with varying levels of DVH incorporation, the architectures of which are described in figure \ref{fig:models_ABC_architectures}.

\begin{figure}
	\centering
	\begin{subfigure}{\linewidth}
		\centering
		\includegraphics[width=11.5cm]{SFPM/modelC.pdf}
		\caption{Model C: No DVH data, \textbf{classical} U-net.}
		\label{fig:model_C_architecture}
	\end{subfigure}
	\begin{subfigure}{\linewidth}
		\centering
		\includegraphics[width=11.5cm]{SFPM/modelB.pdf}
		\caption{Model B: DVH data using DAFT on the \textbf{bottleneck} of the U-net.}
		\label{fig:model_B_architecture}
	\end{subfigure}
	\begin{subfigure}{\linewidth}
		\centering
		\includegraphics[width=11.5cm]{SFPM/modelA.pdf}
		\caption{Model A: DVH data using DAFT on all connections between the encoder and the decoder part of the U-net.}
		\label{fig:model_A_architecture}
	\end{subfigure}
	\caption{Architecture diagram of models A, B and C.}
	\label{fig:models_ABC_architectures}
\end{figure}

The first model referred to as "C" or the \textit{classic} model (figure \ref{fig:model_C_architecture}), consists of a standard 3D U-net architecture without any incorporation of DVH information.
The second model denoted as "B" or the \textit{bottleneck} model (figure \ref{fig:model_B_architecture}), integrates target DVH data using the DAFT technique, as described previously, at the bottleneck layer of the U-net.
In the third model, termed "A" or the \textit{all connections} model (figure \ref{fig:model_A_architecture}), DVH information is incorporated via the DAFT technique both at the bottleneck layer and across all skip connections between the encoder and decoder of the U-net.
During the model training process, the clinical DVHs corresponding to the real delivered doses were used as target DVHs for the optimization.

\subsection{Results}
Our results indicate that incorporating DVH data improves dose prediction's quantitative and qualitative aspects.

\paragraph{Quantitative Performance}
We used the Mean Absolute Error (MAE) between the predicted and ground-truth dose distributions to evaluate model performance.
The incorporation of dose-volume histogram data into the networks resulted in improved quantitative performance.
The MAE measured on the test dataset was $2.42\,\text{Gy}$ for model A, $2.58\,\text{Gy}$ for model B, and $3.18\,\text{Gy}$ for model C.

\paragraph{Prescription Adaptation}
\begin{figure}
	\centering
	\textit{(Solid line is predicted dose DVH, dotted line is target dose DVH.)}
	\begin{subfigure}{\linewidth}
		\centering
		\includegraphics[width=\linewidth]{SFPM/test_patient_0.pdf}
		\caption{Patient 1, prescribed $62\,\text{Gy}$.}
		\label{fig:results_patient_1}
	\end{subfigure}
	\begin{subfigure}{\linewidth}
		\centering
		\includegraphics[width=\linewidth]{SFPM/test_patient_2.pdf}
		\caption{Patient 2, prescribed $78\,\text{Gy}$}
		\label{fig:results_patient_2}
	\end{subfigure}
	\caption{DVHs of the dose predicted by each model on two test set patients.}
	\label{fig:results_patients_12}
\end{figure}
In addition to the quantitative improvements, a qualitative analysis of the DVHs associated with the predicted dose distributions confirmed the benefit of including DVH information.
A key finding from our study was that models A and B could adapt their deep dose predictions based on the prescribed dose, with model A showing a slight advantage over model B regarding accuracy (see figure \ref{fig:results_patients_12}).
The dataset comprised patients with two distinct prescription doses: $62\,\text{Gy}$ and $78\,\text{Gy}$ to the PTV.
Model C consistently predicted dose distributions resembling a $65\,\text{Gy}$ prescription, demonstrating a lack of adaptability to the varying prescription levels (see figure \ref{fig:results_patients_12}).
In contrast, models A and B displayed greater flexibility, successfully adjusting their dose predictions following the prescribed doses for each patient.
This adaptive behavior highlights the effectiveness of incorporating DVH information, allowing the models to tailor dose predictions to specific prescription requirements.

\paragraph{Clinical Relevance}
The ability to adjust dose predictions based on DVH data demonstrates a significant advantage of our approach.
The prescription dose can vary in clinical practice depending on the tumor type, stage, and patient characteristics.
By incorporating DVH data, our models provide a more flexible and personalized approach to dose prediction, allowing the TPS to generate a plan that aligns with clinical objectives and dosimetrist input.

\subsection{Conclusions}
Our study shows the importance of incorporating DVH information into deep learning-based dose prediction models.
In this study, the target DVH links the clinical objectives defined by the dosimetrist and the predicted dose distribution.
By embedding this information into the model, we create a system allowing center-dependent adjustments.
This system also allows interactive adjustment of the dose distribution when the proposed treatment plan is close to clinically acceptable.
The comparison of models A, B, and C highlights the advantages of integrating DVH data in the network.
The comparison also shows that integrating the information once at the bottleneck is sufficient.

An additional advantage of the proposed method is the capacity to generate standardized target DVH templates for treatment planning.
While averaging 3D dose distributions across multiple patients is not feasible, it is possible to compute average DVHs.
These average DVHs can be stratified by anatomical site, prescription dose, and clinical practice, providing a target for dose prediction with no effort.
Dosimetrists and doctors can further modify these templates to meet specific clinical requirements in case of non-standard patients.
Once an optimal set of DVHs is established for a given center's protocols, it can be reused for future patients with only minor adjustments.
This framework could enhance the efficiency and consistency of the treatment planning process.

Our proposed approach demonstrates the feasibility and benefits of incorporating DVH data into deep learning-based dose prediction models for radiotherapy treatment planning.
By embedding DVH information, we improve dose prediction accuracy and allow for interactive fine-tuning based on clinical objectives.
This technique opens the door to a new workflow where dosimetrists can design target DVHs, and the TPS generates the deliverable treatment plan that best matches these targets.
Further studies will explore the generalizability of our model across different cancer types and radiotherapy modalities.
Additionally, clinical validation studies will be crucial to assess the real-world impact of our proposed method on treatment outcomes and workflow efficiency.

%References
%1.	Chris McIntosh, Mattea Welch, Andrea McNiven, David A Jaffray, and Thomas G Purdie.
%Fully automated treatment planning for head and neck radiotherapy using a voxel-based dose prediction and dose mimicking method.
%Physics in Medicine Biology.
%doi: 10.1088/1361-6560/aa71f8
%2.	Sebastian Pölsterl, Tom Nuno Wolf, and Christian Wachinger.
%Combining 3D Image and Tabular Data via the Dynamic Affine Feature Map Transform, page 688–698.
%Springer International Publishing, 2021.
%ISBN 9783030872403.
%doi: 10.1007/978-3-030-87240-3 66



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                                                      %
%   %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%   %
%   %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%   %
%   %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%   %
%   %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%   %
%                                                                      %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


% https://github.com/pauldubois98/SFRO2024
\section{Attention Mechanism on Dose-Volume Histograms for Deep Dose Predictions (SFRO 2024)}
\subsection{Introduction}
%Radiotherapy treatment planning aims to deliver a targeted radiation dose while minimizing damage to healthy tissues.
%Traditionally, dosimetrists define constraints for dose delivery through a semi-manual process.
%Deep learning techniques have emerged to automate parts of this planning by predicting the 3D dose distribution based on patient scans, and then use “dose mimicking” techniques to compute the plan.
%However, these techniques lack interactive feedback for dosimetrists within the treatment planning system (TPS).
%This study proposes using attention mechanism to incorporate target Dose-Volume Histograms (DVHs) into the dose prediction model.
%This enables interactive modifications of the plan, by modifying the target DVHs.

\subsection{Material and Methods}
%We used a cohort of 168 patients (with split 80-10-10 for training-validation-test).
%The models input CT scans, Principal Target Volume (PTV) contour, and Organs at Risk (OARs ) contours; and output a 3D dose.
%We trained the models with a voxel-wise Mean Absolute Error (MAE) , combined with a DVH L1 loss.
%The backbone of the models is a convolutional Unet of depth three.
%Then, we compared three architectures.
%First, a vanilla Unet-0 (with no DVH information).
%Second, a Unet-1 with DVH information incorporated using the DAFT technique.
%Third, a Unet-2, with DVH added via a cross-attention mechanism (our contribution).
%The cross attention takes queries from the 3D data, and keys/values from the target DVHs.
%Finally, the attention output is re-injected in the Unet-3 model via a simple addition.


\subsection{Results}
%Models incorporating DVH data (Unet-1 and Unet-2) achieved superior performance.
%The MAE and mean DVH deviation were improved by Unet-1 and Unet-2, with a minor advantage for the Unet-2.
%
%%Performances of the three models
%%Metric	Unet-0	Unet-1	Unet-2
%%3D dose MAE	3.093 Gy	2.254 Gy	2.210 Gy
%%Mean DVH deviation	1.942 Gy	1.051 Gy	0.930 Gy
%
%The dataset included patients prescribed for either 62 Gy or 78 Gy on the PTV.
%The Unet-1 model was not able to adapt to varying prescriptions, consistently predicting a dose resembling a 65 Gy prescription.
%Conversely, Unet-1 and Unet-2 adjusted their dose predictions suggesting that these models adapted their predictions to be conform with the provided DVHs.

\subsection{Conclusions}
%This study demonstrates the feasibility of incorporating DVH data into deep learning models for dose prediction.
%The inclusion of DVHs resulted in improved dose prediction accuracy and enhanced model adaptability to varying prescriptions.
%This approach paves the way for a novel dose optimization workflow where dosimetrists primarily focus on designing desired DVHs.
%The TPS would then compute the deliverable plan that best matches the specified DVHs.
%Furthermore, DVHs offer greater inter-patient comparability compared to 3D dose distributions.
%This enables the establishment of a standardized target DVH per treatment center.
