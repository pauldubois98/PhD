%In modern radiotherapy, the precision of dose delivery is essential to maximize the therapeutic effect on cancerous tissues while minimizing exposure to surrounding healthy organs.
%Achieving this balance relies heavily on advanced dose optimization techniques that tailor radiation to each patient's specific anatomical and clinical needs.
\section{Discretization}
The optimization process starts with transforming the continuous nature of both the radiation field and the human body into discrete elements.
This transformation enables computation with modern computers.

\subsection[Bixels]{Fluence Map Discretization: Bixels}

%\begin{figure}
%	\centering
%	\begin{subfigure}[c]{0.95\textwidth}
%		\includegraphics[width=\linewidth]{fluence_discretization_plot.pdf}
%		\caption{2D visualization.}
%		\label{fig:fluence_bixel_2D}
%	\end{subfigure}
%	\\
%	\begin{subfigure}[b]{0.95\textwidth}
%		\includegraphics[width=\linewidth]{fluence_discretization_plot3D.pdf}
%		\caption{3D visualization.}
%		\label{fig:fluence_bixel_3D}
%	\end{subfigure}
%	\caption{Example of a fluence discretized to $20 \times 20$ bixels.}
%	\label{fig:fluence_bixel}
%\end{figure}

\begin{figure}
	\centering
	2D visualization
	\\
	\begin{subfigure}[c]{0.45\textwidth}
		\includegraphics[width=\linewidth]{fluence_continuous_2D.pdf}
		\caption{Continuous fluence (2D plot).}
		\label{fig:fluence_bixel_2D_continuous}
	\end{subfigure}
	\begin{subfigure}[c]{0.45\textwidth}
		\includegraphics[width=\linewidth]{fluence_discrete_2D.pdf}
		\caption{Discretized fluence (2D plot).}
		\label{fig:fluence_bixel_2D_discrete}
	\end{subfigure}
	\\
	\vspace{5mm}
	3D visualization
	\\
	\begin{subfigure}[c]{0.45\textwidth}
		\includegraphics[width=\linewidth]{fluence_continuous_3D.pdf}
		\caption{Continuous fluence (3D plot).}
		\label{fig:fluence_bixel_3D_continuous}
	\end{subfigure}
	\begin{subfigure}[c]{0.45\textwidth}
		\includegraphics[width=\linewidth]{fluence_discrete_3D.pdf}
		\caption{Discretized fluence (3D plot).}
		\label{fig:fluence_bixel_3D_discrete}
	\end{subfigure}
	\caption{Example of a fluence discretized to $20 \times 20$ bixels.}
	\label{fig:fluence_bixel}
\end{figure}

Fluence maps are broken down into discrete elements called "bixels" (\textbf{be}am \textbf{el}ements).
Bixels represent small and independent beams of radiation (see a visualization figure \ref{fig:fluence_bixel}).

The width of each bixel is constrained by the width of the multi-leaf collimator leaves.
Modern multi-leaf collimator systems typically have a leaf width of 0.5 cm.

The height of a bixel can be selected arbitrarily, as the leaf can move continuously.
Nevertheless, square bixels (akin to image pixels) are commonly used and will be employed throughout this manuscript.

Bixels whose beams do not affect the planning target volume are typically excluded from calculations to improve computational efficiency.
Activating these bixels could only degrade dose quality by increasing the dose to organs at risk without benefiting the dose distribution within the planning target volume.

\subsection[Voxels]{Human Body Discretization: Voxels}
The human body of the patient is also divided into discrete elements, as it is a three-dimensional object; the elements are "voxels" (\textbf{vo}lume \textbf{el}ements).
Each voxel represents a small portion of tissue within the patient's body, and will determine the granularity of the dose computed.

The maximum resolution of the voxel grid is defined by the planning image, which is typically a CT scan.
It is common practice to resample the planning image to reduce computational demands.
In this manuscript, where new techniques are explored, we have opted to resample the voxel grid to a resolution of 5 mm, ensuring a balance between computational efficiency and accuracy.

Additionally, to further optimize the computational process, only voxels corresponding to the planning target volume (PTV) and organs at risk (OARs) are retained for calculations.
This selective approach reduces unnecessary computation.

\subsection[DI-Matrix]{Dose-Influence Matrix}
The Dose-Influence Matrix (or DI-Matrix) links the discretized fluence map (the bixels values) and the discretized dose distribution within the patient (the dose on each voxel).
This matrix defines how the radiation from each individual bixel influences the dose delivered to every voxel in the patient's body.

We start by converting the 2D fluence map, composed of individual bixel values, into a column vector $b$.
Similarly, we represent dose distribution in the patient's 3D space as a vector $\mathbf{d}$, where each entry corresponds to the dose in a specific voxel.
The DI-Matrix $L$ governs the relationship between these vectors $\mathbf{b}$ and $\mathbf{d}$ via the matrix-vector multiplication $\mathbf{d} = L\mathbf{b}$.
This mathematical operation computes the total dose at each voxel by summing the contributions from all active bixels (here, we assume that the effect of bixels is linear).

The DI-Matrix is constructed by simulating the radiation delivered by each individual bixel.
For each bixel, the jaws of the multi-leaf collimator are virtually opened to allow only that specific beamlet to go through.
A radiation transport model calculates the dose deposited in each voxel, considering the beam's spread and attenuation as it travels through the body.
The resulting 3D dose deposition fills one column of the matrix $L$, corresponding to that bixel's influence on all voxels.
Repeating this process for each bixel generates the entire DI-Matrix.

The accuracy of the dose calculation depends on the precision of the DI-Matrix.
Simple models like pencil beam approximations, which assume a linear trajectory with minimal scattering, are considered too coarse.
In contrast, more advanced simulations, such as Monte Carlo methods, provide a detailed and accurate dose calculation, although at a higher computational cost.
In this manuscript, we employ collapsed cone convolution techniques, which balance efficiency and accuracy.

\section{Naive Optimization Method}
A natural starting point in dose optimization is to attempt to directly achieve the delivery of a uniform dose, equal to the prescription, on all voxels within the PTV, and no dose elsewhere.
We can attempt to find the bixels values delivering this dose by solving a least squares problem.
We attempt to find the fluence map $\mathbf{b}$ that minimizes the difference between the actual dose $\mathbf{d}$ and the target dose $\mathbf{d}_{\text{target}}$, which is set to the prescribed dose within the PTV.

Formally, the optimization problem can be stated as:
$$ \min_\mathbf{b} \| \mathbf{d}_{\text{target}} - L\mathbf{b} \|^2 $$

where $\mathbf{d}_{\text{target}}$ is the target dose vector, defined as follow for a prescription of $p$Gy:
$$ \mathbf{d}_{\text{target}} = p \cdot  \mathds{1}_{\text{PTV}} $$

Here, $\mathds{1}_{\text{PTV}}$ is the indicator vector for PTV that is equal to $1$ for voxels within the PTV and $0$ elsewhere.

To solve this problem, we perform a least squares minimization to find the optimal fluence map $\mathbf{b}$, where the matrix-vector multiplication $L\mathbf{b}$ yields the dose distribution $\mathbf{d}$ across the entire patient volume.

However, this method is often inadequate in practice, as it attempts to solve the system based solely on the prescribed dose within the PTV, while neglecting any constraints on doses to the organs at risk (OARs).
Since no constraints are imposed on the OAR doses, this naive optimization can result in high doses to critical structures, leading to unacceptable treatment plans.
As a result, more sophisticated optimization methods that incorporate dose constraints on OARs and account for dose-volume constraints are necessary to achieve clinically viable treatment plans.
% add 3D dose & DVHs of dose obtained using this technique

\section{Constraints and Importance Factors}
In order to obtain clinically acceptable doses, we need to incorporate the clinical aims in the optimization.

\subsection{Constraints Formulation}
Different organs exhibit varying sensitivities to radiation, which influence their dose tolerance limits \cite{Withers1988} \cite{ICRU83}.
Normal tissues are categorized as serial, parallel, or mixed, based on the functional organization of their sub-units.
This classification determines the appropriate absorbed dose limits for normal tissues.

Serial organs (figure \ref{fig:serial_organ}), such as the spinal cord or esophagus, are characterized by a functional dependence on the integrity of every sub-unit.
Damage to even a tiny region in these tissues can result in the loss of the organ's overall function.
In contrast, parallel organs (figure \ref{fig:parallel_organ}), such as the lung or liver, possess a reserve capacity where damage to a portion of the tissue does not necessarily impair overall function, as long as a critical volume remains intact.

\begin{figure}
	\begin{subfigure}{0.6\textwidth}
		\centering
		\includegraphics[width=0.9\textwidth]{serial_organ.pdf}
		\vspace{4mm}
		\caption{Organ functioning in a serial-like way.}
		\label{fig:serial_organ}
	\end{subfigure}
	\hfill
	\unskip\ \vrule\
	\hfill
	\begin{subfigure}{0.38\textwidth}
		\centering
		\includegraphics[width=0.9\textwidth]{parallel_organ.pdf}
		\caption{Organ functioning in a parallel-like way.}
		\label{fig:parallel_organ}
	\end{subfigure}
	\caption{Organs functioning types.}
	\label{fig:serial_parallel_organ}	
\end{figure}

We define two DVH value measures $V_X$ and $D_{X\%}$ for a structure $S$.
For a given dose $d: \R^3 \to \R^+$, $V_X$ is defined as the volume of the three dimensional structure $S \subseteq \R^3$ that receives a dose equal to or higher than $X$, that is:
$$ V_X = \frac{\vol{\left\lbrace p \in S \subset \R^3 \mid d(p) \geq X \right\rbrace}}{\vol{S}}.$$
This can be approximated using the discretized dose on voxels $\mathbf{d}$:
$$ V_X \approx \frac{ \#{\left\lbrace v \in S \mid \mathbf{d}_v \geq X \right\rbrace}}{\#\left\{ v \in S \right\}}$$
with $v \in S$ voxels of the structure $S$, $\mathbf{d}_v$ the dose of $\mathbf{d}$ associated with voxel $v$, and $\#$ refers to voxel count.

Similarly, we define $D_{X\%}$ as the minimal dose (in Gy) delivered to that the $X\%$ most irradiated region of the structure, that is:
$$D_{X\%} = \min \left\lbrace d(p) \mid p \in S_{X\%} \right\rbrace$$
where $S_{X\%} \subseteq S$ is the $X\%$ most irradiated region of $S$.
Again, it can be approximated using the discretized dose on voxels $\mathbf{d}$:
$$D_{X\%} \approx \min \left\lbrace \mathbf{d}_v \mid v \in S_{X\%} \right\rbrace$$
where $v \in S_{X\%}$ are the $X\%$ most irradiated voxels of $S$.

For parallel-like structures, dose–volume reporting specifying $V_D$ is commonly used, with $D$ adapted to the specific organ.
For instance, \cite{Graham1995} demonstrated a correlation between the incidence and severity of lung pneumonitis and $V_{20 \text{ Gy}}$, the volume of the lung receiving more than 20 Gy.
Additionally, in parallel-like structures, the median absorbed dose ($D_{50\%}$), provides a valuable measure of the total dose delivered to the organ at risk.

For serial-like organs, it is recommended to report $D_{2\%}$ as the maximum absorbed dose, as $D_{0\%}$ is subject to noise.

Finally, for organs with a mixed parallel-serial structure, it is advised to report $D_{50\%}$, $D_{2\%}$, and $V_D$, with $D$ selected based on the threshold beyond which there is a significant risk of serious complications.

\begin{figure}
	\begin{subfigure}[b]{0.48\textwidth}
		\caption{Irradiation of organs at risk with one heat point.}
		\label{fig:organ_radiation_point}
		\centering
		\vspace{3mm}
		\hspace{1.2cm}
		Treatment Dose
		\\
		\includegraphics[width=0.55\textwidth]{serial_heat_point.pdf}
		\vbar
		\includegraphics[width=0.35\textwidth]{parallel_heat_point.pdf}
		\\
		\hspace{1.1cm}
		Post Treatment
		\\
		\noindent
		\begin{subfigure}[b]{0.55\textwidth}
			\addtocounter{subfigure}{-1}
			\renewcommand\thesubfigure{\alph{subfigure}1}
			\centering
			\includegraphics[width=\textwidth]{serial_heat_point_post.pdf}
			\vspace{0.5mm}
			\caption{Serial organ dies.}
		\end{subfigure}
		\vbar
		\begin{subfigure}[b]{0.35\textwidth}
			\addtocounter{subfigure}{-1}
			\renewcommand\thesubfigure{\alph{subfigure}2}
			\centering
			\includegraphics[width=\textwidth]{parallel_heat_point_post.pdf}
			\caption{Parallel organ survives.}
		\end{subfigure}	
	\end{subfigure}
	\vbar
	\begin{subfigure}[b]{0.48\textwidth}
		\caption{Irradiation of organs at risk with spread heat dose.}
		\label{fig:organ_radiation_square}
		\centering
		\vspace{3mm}
		\hspace{1.2cm}
		Treatment Dose
		\\
		\includegraphics[width=0.55\textwidth]{serial_heat_square.pdf}
		\vbar
		\includegraphics[width=0.35\textwidth]{parallel_heat_square.pdf}
		\\
		\hspace{1.1cm}
		Post Treatment
		\\
		\noindent
		\begin{subfigure}[b]{0.55\textwidth}
			\addtocounter{subfigure}{-1}
			\renewcommand\thesubfigure{\alph{subfigure}1}
			\centering
			\includegraphics[width=\textwidth]{serial_heat_square_post.pdf}
			\vspace{0.5mm}
			\caption{Serial organ survives.}
		\end{subfigure}
		\vbar
		\begin{subfigure}[b]{0.35\textwidth}
			\addtocounter{subfigure}{-1}
			\renewcommand\thesubfigure{\alph{subfigure}2}
			\centering
			\includegraphics[width=\textwidth]{parallel_heat_square_post.pdf}
			\caption{Parallel organ dies.}
		\end{subfigure}	
	\end{subfigure}
	\addtocounter{subfigure}{-1}
	\caption{Irradiation type survival of organs serial-like and parallel-like.}
	\label{fig:serial_parallel_organ_radiation}	
\end{figure}

\subsection{Optimization Problem}
After the doctors have formulated maximal dose constraints for each OARs, and PTV coverage constraints $\mathcal{C}$, we can formulate the mathematical optimization problem.

Constraints $c \in \mathcal{C}$ are formulated as $c = \left( S, D, V, \pm \right)$ where $D$ is in Grey, $V$ is a \%, and $\pm$ means the constraint is maximal/minimal.
\\
\textit{\textbf{E.g.:}} $c_{PTV+} = \left( \text{PTV}, \ 76\,Gy, \ 95\,\%, \ + \right)$ means that for the PTV structure, we need $D_{95\%} \geq 76\,\textit{Gy}$ (or, equivalently, $V_{76\textit{Gy}} \geq 95 \%$).
\\
\textit{\textbf{E.g. (bis):}} $c_{\text{organ}} = \left( \text{organ}, \ 25\, Gy, \ 20\,\%, \ - \right)$ means that for the 'organ' structure, we need $D_{20\%} \leq 25\,\textit{Gy}$ (or, equivalently, $V_{25\textit{Gy}} \leq 25 \%$).
This constraint example is illustrated in figure \ref{fig:constraint_plot}.

\begin{figure}
	\centering
	\begin{subfigure}{0.32\textwidth}
		\centering
		\includegraphics[width=0.9\textwidth]{constraint_plot.pdf}
		\caption{Maximal dose constraint not met.}
		\label{fig:constraint_plot_unmet}
	\end{subfigure}
	\begin{subfigure}{0.32\textwidth}
		\centering
		\includegraphics[width=0.9\textwidth]{constraint_plot_met.pdf}
		\caption{Maximal dose constraint met.}
		\label{fig:constraint_plot_met}
	\end{subfigure}
	\begin{subfigure}{0.32\textwidth}
		\centering
		\includegraphics[width=0.9\textwidth]{constraint_plot_min.pdf}
		\caption{Minimal dose constraint unmet.}
		\label{fig:constraint_plot_min}
	\end{subfigure}
	\caption*{
		Figures \ref{fig:constraint_plot_unmet}, \ref{fig:constraint_plot_met}:
		Typical DVH of an OAR, with visualization of the maximal dose constraint $D_{20\%} \leq 25\,\text{Gy}$ (or $V_{25\text{Gy}} \leq 20\,\%$).\\
		Figure \ref{fig:constraint_plot_min}:
		Typical DVH of a PTV, with visualization of the minimal dose constraint $D_{95\%} \geq 76\,\text{Gy}$ (or $V_{76\text{Gy}} \geq 95\,\%$).
	}
	\label{fig:constraint_plot}
\end{figure}

We only calculate a voxel-discretized version $\mathbf{d}$ of the dose $d: \R^3 \to \R^+$, using a bixel-discretized version $\mathbf{b}$ of the fluence maps $f^\theta: \R^2 \to \R^+$ for each selected angle $\theta$.
Hence, we formulate the optimization problem on the discretized information.

\paragraph{Ideal}
In the ideal case, it is possible to meet all constraints, and we try to minimize further the dose $\mathbf{d}$ on the OARs.
Mathematically, we find the values for $\mathbf{b}$ giving dose $\mathbf{d} = L\mathbf{d}$ such that all DVH constraints $\mathcal{C}$ are satisfied, and $\sum_{v \in \text{OARs}} \mathbf{d}_v^2 \ $ is minimum (where $\mathbf{d}_v$ is the dose on voxel $v$, and $v \in \text{OARs}$ are the voxels $v$ belonging to an OAR):
$$\min_{\mathbf{b}} \sum_{v \in OARs} \mathbf{d}_v^2 \quad \text{ with } \mathbf{d} = L\mathbf{b} \text{ and such that } \forall c \in \mathcal{C}, c \text{ is satisfied.}$$

\paragraph{Practical}
In practice, constraints formulated by the doctors are too hard to satisfy.
Hence, we create one objective function $f_c$ for each constraint $c \in \mathcal{C}$, that will decrease as we get closer to satisfying the constraint.
The optimization problem becomes:
$$\min_{\mathbf{b}} \sum_{c \in \mathcal{C}} w_c f_c(\mathbf{d})$$
with $w_c$ importance factor of constraint $c$.

\paragraph{Penalization functions}
Given a constraint $c = \left( S, D\,\text{Gy}, V\,\%, \pm \right)$, multiple approaches can be considered for defining an objective function \( f_c \).
Here, we explore three commonly used methods:

\begin{enumerate}
	\item \textbf{Penalizing the lower $100-V\,\%$ dose voxels}:
	This method penalises a fixed number of voxels, but it tends to be noisy since the lower $V\%$ voxels can fluctuate with each optimization iteration.
	\item \textbf{Penalizing voxels with dose $>D$ Gy}:
	This approach yields a convex objective function.
	\item \textbf{Penalizing the lower $100-V\,\%$ dose voxels with dose $>D\,\text{Gy}$}:
	This is the most advanced method but remains prone to noise for the same reason as the first approach.
\end{enumerate}

\begin{figure}
	\centering
	\includegraphics[width=0.6\textwidth]{constraint_penalisation.pdf}
	\hfill
	\includegraphics[width=0.35\textwidth]{constraint_penalisation_plot.pdf}
	\caption{Penalizations of constraint $D_{20\%}< 25\,\text{Gy}$ on a structure of 10 voxels.}
	\label{fig:constraint_penalisation}
\end{figure}


Once the set of penalised voxels is selected, the penalisation power $p$ must be determined, with common choices being $p=1$ or $p=2$.
We opt for penalising voxels with dose greater than $D$ Gy and set $p=2$.
This choice makes the objective function convex, as a weighted sum of convex functions.
Desirable properties such as the existence of a unique global minimum once the values of $w_c$ are fixed follows from convexity of the objective function.


\section{Dose Mimicking}
% principle
% => is a simpler problem
% => only works if dose to mimick is nearly acheaivable
% => can arise if machine is changing during treatment
% optim problem

\section{Optimization Algorithm Review for Dosimetry}
\subsection{Introduction}
% ArXiV paper

\subsection{Methods}
%Efficiently solving this optimization problem often involves designing the objective function to be convex, thereby providing a well-defined target for the optimization process.
%Gradient-based methods, Newtonian algorithms, or quasi-Newtonian algorithms are commonly employed for this purpose.
%We aim at benchmarking state-of-the-art open-source optimization algorithms for the specific task of radiotherapy dosimetry.

\subsection{Data}
% TG-119 \cite{AAPM-TG119}
\subsection{Objective function}
% details on the one used for this study
% => tested variations (p=1,2), changed importance factors, but v similar results
\subsection{Open-source Optimizers}
\paragraph{(Stochastic) Gradient Descent}
\paragraph{Conjugate Gradient}
\paragraph{Newton}
\paragraph{SLSQP}
\paragraph{RMSprop}
\paragraph{BFGS-based}
\subparagraph{Pure BFGS}
\subparagraph{L-BFGS}
\paragraph{Adam-based}
\subparagraph{Pure Adam}
\subparagraph{RAdam}
\subparagraph{NAdam}
\subparagraph{AdamDelta}
\subparagraph{Adamax}
\paragraph{Rprop}
\paragraph{Other optimizers variations}
%In addition, we also tested AdamW, Adagrad and ASGD.
%However, AdamW \& Adagrad behaved similarly to Adam, and ASGD behaved similarly to SGD.

\subsection{Results}
% 4 TGG-119 cases figures
\paragraph{Newton's method}
\paragraph{Best Algorithms}
\paragraph{LBFGS vs BFGS}

\subsection{Discussion}
